name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Resolve Dependencies
        run: mvn dependency:resolve -q
      
      - name: SpotBugs Security Scan
        run: mvn spotbugs:check -q
      
      - name: PMD Code Quality
        run: mvn pmd:check -q
      
      - name: Unit Tests
        run: mvn test -q
      
      - name: Integration Tests
        run: mvn verify -q
      
      - name: Code Coverage Report
        run: mvn jacoco:report -q
      
      - name: SonarQube Scan
        run: mvn sonar:sonar -Dsonar.projectKey=java-bootstrap -q || echo "SonarQube skipped"
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
      
      - name: Build Docker Image
        run: mvn clean package -DskipTests -Pdocker -q


      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        id: docker_build
        run: |
          IMAGE_TAG=${{ github.sha }}
          REPO_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')

          echo "repo_name=$REPO_NAME" >> $GITHUB_ENV
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV
          
          docker build -t ghcr.io/$REPO_NAME:$IMAGE_TAG .
          docker push ghcr.io/$REPO_NAME:$IMAGE_TAG
          
          docker tag ghcr.io/$REPO_NAME:$IMAGE_TAG ghcr.io/$REPO_NAME:latest
          docker push ghcr.io/$REPO_NAME:latest


      - name: Update Infra Repository (GitOps)
        if: github.ref == 'refs/heads/main'
        env:
          INFRA_REPO: rg-hermann/java-bootstrap-infra
          PAT_TOKEN: ${{ secrets.PAT_INFRA }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          
          git clone https://x-access-token:${{ secrets.PAT_INFRA }}@github.com/$INFRA_REPO.git infra-repo
          cd infra-repo
          
          sed -i "s/tag: .*/tag: \"${{ github.sha }}\"/" values-dev.yaml
          
          git add values-dev.yaml
          git commit -m "chore(deps): update image tag to ${{ github.sha }}"
          git push